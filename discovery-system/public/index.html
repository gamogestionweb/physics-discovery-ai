<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physics Discovery - Multi-Agent System</title>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --accent-blue: #00d4ff;
      --accent-purple: #a855f7;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-orange: #f97316;
      --accent-yellow: #eab308;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --border-color: #2d2d3a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text h1 {
      font-size: 1.2rem;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status-bar {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 0.85rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.active { background: var(--accent-green); }
    .status-dot.inactive { background: var(--accent-red); animation: none; }
    .status-dot.thinking { background: var(--accent-yellow); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Main Layout */
    .main-container {
      display: grid;
      grid-template-columns: 280px 1fr 380px;
      height: calc(100vh - 70px);
    }

    /* Sidebar - Agents */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      padding: 15px;
    }

    .sidebar h2 {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .agent-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .agent-card:hover {
      border-color: var(--accent-blue);
    }

    .agent-card.tenth-man {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(168, 85, 247, 0.15));
      border: 1px solid var(--accent-red);
    }

    .agent-card.synthesizer {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 182, 212, 0.15));
      border: 1px solid #10b981;
    }

    .agent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .agent-name {
      font-weight: bold;
      font-size: 0.9rem;
      color: var(--accent-blue);
    }

    .agent-card.tenth-man .agent-name {
      color: var(--accent-red);
    }

    .agent-card.synthesizer .agent-name {
      color: #10b981;
    }

    .agent-type {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--bg-primary);
    }

    .agent-type.deepseek { color: var(--accent-green); }
    .agent-type.claude { color: var(--accent-purple); }
    .agent-type.gpt { color: #10b981; }

    .agent-personality {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .agent-thinking {
      margin-top: 8px;
      padding: 8px;
      background: var(--bg-primary);
      border-radius: 5px;
      font-size: 0.7rem;
      color: var(--accent-yellow);
      display: none;
      max-height: 60px;
      overflow: hidden;
    }

    .agent-card.is-thinking .agent-thinking {
      display: block;
    }

    /* Central Panel */
    .central-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Control Bar */
    .control-bar {
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .control-btn.primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
    }

    .control-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .control-btn.danger {
      background: var(--accent-red);
      color: white;
    }

    .control-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Deliberation Feed - MAIN AREA */
    .deliberation-feed {
      flex: 1;
      overflow-y: auto;
      padding: 15px 20px;
      background: var(--bg-primary);
    }

    .deliberation-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-blue);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .deliberation-item.theory { border-left-color: var(--accent-purple); }
    .deliberation-item.challenge { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
    .deliberation-item.discovery { border-left-color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }
    .deliberation-item.experiment { border-left-color: var(--accent-orange); }
    .deliberation-item.discussion { border-left-color: var(--accent-yellow); }
    .deliberation-item.thinking { border-left-color: var(--accent-blue); }

    .deliberation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .deliberation-agent {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .agent-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .agent-info {
      display: flex;
      flex-direction: column;
    }

    .agent-info .name {
      font-weight: bold;
      font-size: 0.9rem;
    }

    .agent-info .role {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .deliberation-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .deliberation-type {
      font-size: 0.65rem;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 10px;
    }

    .deliberation-content {
      font-size: 0.85rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .deliberation-content strong {
      color: var(--accent-blue);
    }

    .deliberation-content .highlight {
      background: rgba(0, 212, 255, 0.2);
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* Thinking block inside deliberation */
    .thinking-block {
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 12px;
      margin-top: 10px;
      font-size: 0.8rem;
      border: 1px solid var(--border-color);
    }

    .thinking-block h4 {
      color: var(--accent-yellow);
      font-size: 0.75rem;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    /* Actions taken */
    .actions-block {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
    }

    .action-item {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 0.75rem;
      margin-right: 8px;
      margin-top: 5px;
    }

    /* Right Panel */
    .right-panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .panel-tab.active {
      color: var(--accent-blue);
      border-bottom: 2px solid var(--accent-blue);
      background: rgba(0, 212, 255, 0.05);
    }

    .panel-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }

    .stat-box {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-blue);
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    /* Theories */
    .theory-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .theory-name {
      font-weight: bold;
      color: var(--accent-purple);
      margin-bottom: 4px;
    }

    .theory-author {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .theory-description {
      font-size: 0.8rem;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .theory-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      text-transform: uppercase;
    }

    .theory-status.proposed { background: var(--accent-yellow); color: black; }
    .theory-status.validated { background: var(--accent-green); color: white; }
    .theory-status.challenged { background: var(--accent-red); color: white; }

    /* API Keys Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 15px;
      padding: 25px;
      width: 450px;
      max-width: 90%;
      border: 1px solid var(--border-color);
    }

    .modal h2 {
      margin-bottom: 15px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.85rem;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .form-group small {
      display: block;
      margin-top: 4px;
      color: var(--text-secondary);
      font-size: 0.7rem;
    }

    /* Loading */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--text-secondary);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Knowledge Base Section */
    .knowledge-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }

    .knowledge-section h3 {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .knowledge-item {
      font-size: 0.75rem;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      margin-bottom: 5px;
      cursor: pointer;
    }

    .knowledge-item:hover {
      background: var(--bg-primary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-blue); }

    /* Agent colors */
    .agent-euler { background: linear-gradient(135deg, #00d4ff, #0099cc); }
    .agent-faraday { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .agent-democritus { background: linear-gradient(135deg, #f97316, #ea580c); }
    .agent-hubble { background: linear-gradient(135deg, #a855f7, #9333ea); }
    .agent-shannon { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .agent-boltzmann { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .agent-bohr { background: linear-gradient(135deg, #ec4899, #db2777); }
    .agent-einstein { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .agent-anderson { background: linear-gradient(135deg, #14b8a6, #0d9488); }
    .agent-tenthman { background: linear-gradient(135deg, #ef4444, #dc2626); }
  </style>
</head>
<body>
  <!-- API Keys Modal -->
  <div class="modal-overlay" id="apiModal">
    <div class="modal">
      <h2>üî¨ Initialize Discovery System</h2>
      <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.85rem;">
        Enter your API keys to start the 11-agent physics exploration.
      </p>
      <form id="apiForm">
        <div class="form-group">
          <label>DeepSeek API Key</label>
          <input type="password" id="deepseekKey" placeholder="sk-..." required>
          <small>For 9 theory-proposing agents</small>
        </div>
        <div class="form-group">
          <label>Claude API Key (Anthropic)</label>
          <input type="password" id="claudeKey" placeholder="sk-ant-..." required>
          <small>For the Tenth Man (Devil's Advocate)</small>
        </div>
        <div class="form-group">
          <label>OpenAI API Key</label>
          <input type="password" id="openaiKey" placeholder="sk-..." required>
          <small>For the Synthesizer (GPT-5.2)</small>
        </div>
        <button type="submit" class="control-btn primary" style="width: 100%; justify-content: center;">
          Initialize System
        </button>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">‚öõ</div>
      <div class="logo-text">
        <h1>Physics Discovery System</h1>
      </div>
    </div>
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot inactive" id="systemStatus"></span>
        <span id="statusText">Not Initialized</span>
      </div>
      <div class="status-item">
        <span id="cycleLabel">Cycle</span>: <strong id="cycleCount">0</strong>
      </div>
      <select id="langSelect" onchange="changeLanguage(this.value)" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: white; font-family: inherit; cursor: pointer;">
        <option value="en">üá¨üáß English</option>
        <option value="es">üá™üá∏ Espa√±ol</option>
      </select>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Sidebar - Agents -->
    <aside class="sidebar">
      <h2>ü§ñ Agents (10)</h2>
      <div id="agentsList">
        <div class="agent-card">
          <div class="agent-header">
            <span class="agent-name">Waiting...</span>
          </div>
          <div class="agent-personality">Initialize system to see agents</div>
        </div>
      </div>
    </aside>

    <!-- Central Panel - Deliberations -->
    <main class="central-panel">
      <div class="control-bar">
        <button class="control-btn primary" id="startBtn" disabled>
          ‚ñ∂ Start
        </button>
        <button class="control-btn secondary" id="cycleBtn" disabled>
          ‚ü≥ Run Cycle
        </button>
        <button class="control-btn secondary" id="autoBtn" disabled>
          ‚èØ Auto
        </button>
        <button class="control-btn danger" id="stopBtn" disabled>
          ‚èπ Stop
        </button>
        <select id="topicSelect" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: white; font-family: inherit;">
          <option value="">Open Exploration</option>
          <option value="dark_matter">Dark Matter Mystery</option>
          <option value="quantum_gravity">Quantum Gravity</option>
          <option value="measurement">Measurement Problem</option>
          <option value="information">Information as Fundamental</option>
          <option value="unification">Grand Unification</option>
        </select>
        <div style="margin-left: auto; display: flex; gap: 8px;">
          <button class="control-btn secondary" onclick="downloadReport('en')">
            üì• Report (EN)
          </button>
          <button class="control-btn secondary" onclick="downloadReport('es')">
            üì• Informe (ES)
          </button>
          <button class="control-btn secondary" onclick="clearFeed()">
            üóë
          </button>
        </div>
      </div>

      <div class="deliberation-feed" id="deliberationFeed">
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
          <div style="font-size: 4rem; margin-bottom: 20px;">üî≠</div>
          <h3>Welcome to Physics Discovery</h3>
          <p style="margin-top: 10px; font-size: 0.9rem;">
            Initialize the system with your API keys to begin.
          </p>
          <div style="margin-top: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; font-size: 0.8rem;">
            <p><strong>How it works:</strong></p>
            <ol style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
              <li>Enter DeepSeek + Claude + OpenAI API keys</li>
              <li>Click <strong>Start</strong> to begin a session</li>
              <li>Click <strong>Run Cycle</strong> to make agents think</li>
              <li>Watch their deliberations appear here!</li>
            </ol>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Panel -->
    <aside class="right-panel">
      <div class="panel-tabs">
        <button class="panel-tab active" data-tab="stats">Stats</button>
        <button class="panel-tab" data-tab="theories">Theories</button>
        <button class="panel-tab" data-tab="knowledge">Knowledge</button>
      </div>

      <div class="panel-content" id="panelContent">
        <div id="statsTab">
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="theoriesCount">0</div>
              <div class="stat-label">Theories</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="discoveriesCount">0</div>
              <div class="stat-label">Discoveries</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="challengesCount">0</div>
              <div class="stat-label">Challenges</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="experimentsCount">0</div>
              <div class="stat-label">Experiments</div>
            </div>
          </div>

          <h3 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.8rem;">LIVE AGENT STATUS</h3>
          <div id="agentStatusList"></div>
        </div>

        <div id="theoriesTab" style="display: none;">
          <div id="theoriesList">
            <p style="color: var(--text-secondary); font-size: 0.8rem;">No theories proposed yet</p>
          </div>
        </div>

        <div id="knowledgeTab" style="display: none;">
          <h3 style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.8rem;">UNEXPLAINED PHENOMENA</h3>
          <div id="phenomenaList" style="font-size: 0.75rem;">
            <div class="knowledge-item">Dark Matter</div>
            <div class="knowledge-item">Dark Energy</div>
            <div class="knowledge-item">Quantum Gravity</div>
            <div class="knowledge-item">Black Hole Information Paradox</div>
            <div class="knowledge-item">Measurement Problem</div>
            <div class="knowledge-item">Arrow of Time</div>
            <div class="knowledge-item">Hubble Tension</div>
            <div class="knowledge-item">Matter-Antimatter Asymmetry</div>
            <div class="knowledge-item">Fine Structure Constant</div>
            <div class="knowledge-item">Neutrino Masses</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // State
    let ws = null;
    let isInitialized = false;
    let isRunning = false;
    let isAutoMode = false;
    let cycleCount = 0;
    let theories = [];
    let challengesCount = 0;
    let experimentsCount = 0;
    let discoveriesCount = 0;

    // Full deliberation log for download
    let fullDeliberationLog = [];
    let sessionStartTime = null;
    let currentLang = 'en';

    // UI Translations
    const uiText = {
      en: {
        title: "Physics Discovery System",
        notInitialized: "Not Initialized",
        ready: "Ready",
        running: "Running",
        cycle: "Cycle",
        agents: "Agents",
        start: "‚ñ∂ Start",
        runCycle: "‚ü≥ Run Cycle",
        auto: "‚èØ Auto",
        stopAuto: "‚è∏ Stop Auto",
        stop: "‚èπ Stop",
        openExploration: "Open Exploration",
        darkMatter: "Dark Matter Mystery",
        quantumGravity: "Quantum Gravity",
        measurement: "Measurement Problem",
        information: "Information as Fundamental",
        unification: "Grand Unification",
        reportEN: "üì• Report (EN)",
        reportES: "üì• Informe (ES)",
        welcome: "Welcome to Physics Discovery",
        welcomeDesc: "Initialize the system with your API keys to begin.",
        howItWorks: "How it works:",
        step1: "Enter DeepSeek + Claude API keys",
        step2: "Click Start to begin a session",
        step3: "Click Run Cycle to make agents think",
        step4: "Watch their deliberations appear here!",
        stats: "Stats",
        theories: "Theories",
        knowledge: "Knowledge",
        theoriesLabel: "Theories",
        discoveries: "Discoveries",
        challenges: "Challenges",
        experiments: "Experiments",
        liveStatus: "LIVE AGENT STATUS",
        noTheories: "No theories proposed yet",
        unexplained: "UNEXPLAINED PHENOMENA",
        initSystem: "Initialize Discovery System",
        initDesc: "Enter your API keys to start the 11-agent physics exploration.",
        deepseekKey: "DeepSeek API Key",
        claudeKey: "Claude API Key (Anthropic)",
        openaiKey: "OpenAI API Key",
        for9agents: "For 9 theory-proposing agents",
        forTenthMan: "For the Tenth Man (Devil's Advocate)",
        forSynthesizer: "For the Synthesizer (GPT-5.2)",
        initialize: "Initialize System",
        initializing: "Initializing...",
        sessionStarted: "Session started",
        allAgentsReady: "All 11 agents are now active and ready to explore physics.",
        cycleCompleted: "Cycle completed",
        isThinking: "is thinking...",
        internalReasoning: "Internal Reasoning",
        actionsTaken: "Actions Taken",
        messageToOthers: "Message to other agents",
        newTheory: "NEW THEORY PROPOSED",
        challengeTo: "CHALLENGE TO",
        analyzing: "Analyzing theory",
        searchingFlaws: "Searching for flaws, hidden assumptions, and alternative explanations...",
        runningExperiment: "RUNNING EXPERIMENT",
        experimentCompleted: "EXPERIMENT COMPLETED",
        discussion: "DISCUSSION",
        topic: "Topic",
        participants: "Participants",
        discovery: "DISCOVERY!",
        errorInCycle: "Error in cycle"
      },
      es: {
        title: "Sistema de Descubrimiento F√≠sico",
        notInitialized: "No Inicializado",
        ready: "Listo",
        running: "Ejecutando",
        cycle: "Ciclo",
        agents: "Agentes",
        start: "‚ñ∂ Iniciar",
        runCycle: "‚ü≥ Ejecutar Ciclo",
        auto: "‚èØ Auto",
        stopAuto: "‚è∏ Detener Auto",
        stop: "‚èπ Detener",
        openExploration: "Exploraci√≥n Libre",
        darkMatter: "Misterio de la Materia Oscura",
        quantumGravity: "Gravedad Cu√°ntica",
        measurement: "Problema de la Medici√≥n",
        information: "Informaci√≥n como Fundamental",
        unification: "Gran Unificaci√≥n",
        reportEN: "üì• Report (EN)",
        reportES: "üì• Informe (ES)",
        welcome: "Bienvenido al Descubrimiento F√≠sico",
        welcomeDesc: "Inicializa el sistema con tus API keys para comenzar.",
        howItWorks: "C√≥mo funciona:",
        step1: "Ingresa las API keys de DeepSeek + Claude",
        step2: "Haz clic en Iniciar para comenzar",
        step3: "Haz clic en Ejecutar Ciclo para que los agentes piensen",
        step4: "¬°Observa sus deliberaciones aparecer aqu√≠!",
        stats: "Estad√≠sticas",
        theories: "Teor√≠as",
        knowledge: "Conocimiento",
        theoriesLabel: "Teor√≠as",
        discoveries: "Descubrimientos",
        challenges: "Desaf√≠os",
        experiments: "Experimentos",
        liveStatus: "ESTADO EN VIVO DE AGENTES",
        noTheories: "A√∫n no hay teor√≠as propuestas",
        unexplained: "FEN√ìMENOS SIN EXPLICAR",
        initSystem: "Inicializar Sistema de Descubrimiento",
        initDesc: "Ingresa tus API keys para iniciar la exploraci√≥n con 11 agentes.",
        deepseekKey: "API Key de DeepSeek",
        claudeKey: "API Key de Claude (Anthropic)",
        openaiKey: "API Key de OpenAI",
        for9agents: "Para 9 agentes que proponen teor√≠as",
        forTenthMan: "Para el D√©cimo Hombre (Abogado del Diablo)",
        forSynthesizer: "Para el Sintetizador (GPT-5.2)",
        initialize: "Inicializar Sistema",
        initializing: "Inicializando...",
        sessionStarted: "Sesi√≥n iniciada",
        allAgentsReady: "Los 11 agentes est√°n activos y listos para explorar f√≠sica.",
        cycleCompleted: "Ciclo completado",
        isThinking: "est√° pensando...",
        internalReasoning: "Razonamiento Interno",
        actionsTaken: "Acciones Tomadas",
        messageToOthers: "Mensaje a otros agentes",
        newTheory: "NUEVA TEOR√çA PROPUESTA",
        challengeTo: "DESAF√çO A",
        analyzing: "Analizando teor√≠a",
        searchingFlaws: "Buscando fallas, suposiciones ocultas y explicaciones alternativas...",
        runningExperiment: "EJECUTANDO EXPERIMENTO",
        experimentCompleted: "EXPERIMENTO COMPLETADO",
        discussion: "DISCUSI√ìN",
        topic: "Tema",
        participants: "Participantes",
        discovery: "¬°DESCUBRIMIENTO!",
        errorInCycle: "Error en el ciclo"
      }
    };

    // Agent info
    const agentInfo = {
      euler: { name: 'Euler', color: '#00d4ff', emoji: 'üìê', role: 'Mathematical purist' },
      faraday: { name: 'Faraday', color: '#22c55e', emoji: 'üî¨', role: 'Empirical pragmatist' },
      democritus: { name: 'Democritus', color: '#f97316', emoji: '‚öõ', role: 'Particle reductionist' },
      hubble: { name: 'Hubble', color: '#a855f7', emoji: 'üåå', role: 'Cosmic visionary' },
      shannon: { name: 'Shannon', color: '#06b6d4', emoji: 'üíæ', role: 'Information theorist' },
      boltzmann: { name: 'Boltzmann', color: '#eab308', emoji: 'üé≤', role: 'Statistical thinker' },
      bohr: { name: 'Bohr', color: '#ec4899', emoji: 'üîÆ', role: 'Quantum philosopher' },
      einstein: { name: 'Einstein', color: '#8b5cf6', emoji: 'üåÄ', role: 'Grand unifier' },
      anderson: { name: 'Anderson', color: '#14b8a6', emoji: 'üß©', role: 'Emergence champion' },
      tenthMan: { name: 'Advocatus Diaboli', color: '#ef4444', emoji: 'üëπ', role: 'THE TENTH MAN' },
      synthesizer: { name: 'Nexus', color: '#10b981', emoji: 'üîó', role: 'THE SYNTHESIZER' }
    };

    // DOM Elements
    const apiModal = document.getElementById('apiModal');
    const apiForm = document.getElementById('apiForm');
    const systemStatus = document.getElementById('systemStatus');
    const statusText = document.getElementById('statusText');
    const cycleCountEl = document.getElementById('cycleCount');
    const startBtn = document.getElementById('startBtn');
    const cycleBtn = document.getElementById('cycleBtn');
    const autoBtn = document.getElementById('autoBtn');
    const stopBtn = document.getElementById('stopBtn');
    const topicSelect = document.getElementById('topicSelect');
    const deliberationFeed = document.getElementById('deliberationFeed');
    const agentsList = document.getElementById('agentsList');

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      connectWebSocket();
      loadSavedLanguage();
    });

    function setupEventListeners() {
      apiForm.addEventListener('submit', handleApiSubmit);
      startBtn.addEventListener('click', startSession);
      cycleBtn.addEventListener('click', runCycle);
      autoBtn.addEventListener('click', toggleAutoMode);
      stopBtn.addEventListener('click', stopSession);

      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => console.log('WebSocket connected');
      ws.onmessage = (event) => handleWebSocketMessage(JSON.parse(event.data));
      ws.onclose = () => setTimeout(connectWebSocket, 3000);
    }

    function handleWebSocketMessage(message) {
      console.log('WS Message:', message.type, message.data);

      switch (message.type) {
        case 'initial_state':
          updateState(message.data);
          break;

        case 'session_started':
          isRunning = true;
          sessionStartTime = new Date().toISOString();
          fullDeliberationLog = []; // Reset log for new session
          updateButtons();
          addDeliberation('system', `üöÄ Session started: ${message.data.topic}\n\nAll 11 agents are now active and ready to explore physics.`, 'session');
          break;

        case 'session_ended':
          isRunning = false;
          updateButtons();
          addDeliberation('system', 'Session ended', 'session', 'üõë');
          break;

        case 'cycle_started':
          addDeliberation('system', `Starting Cycle ${message.data.cycleNumber}...`, 'cycle', '‚è±');
          break;

        case 'cycle_completed':
          cycleCount = message.data.cycleNumber;
          cycleCountEl.textContent = cycleCount;
          addDeliberation('system', `Cycle ${cycleCount} completed`, 'cycle', '‚úÖ');
          break;

        case 'agent_thinking':
          updateAgentThinking(message.data.agentName, true, message.data.personality);
          addDeliberation(
            message.data.agentKey || getAgentKeyByName(message.data.agentName),
            `<strong>üß† ${message.data.agentName} is thinking...</strong>
<em style="color: var(--text-secondary);">${message.data.personality || ''}</em>`,
            'thinking'
          );
          break;

        case 'agent_thought':
          updateAgentThinking(message.data.agentName, false);
          let thoughtContent = `<strong>üéØ Focus:</strong> ${message.data.focus || 'General exploration'}`;

          // Show agent info
          if (message.data.personality) {
            thoughtContent += `
<div style="font-size: 0.75rem; color: var(--text-secondary); margin: 5px 0;">
<em>${message.data.personality}</em> ${message.data.expertise ? `| Expertise: ${message.data.expertise.join(', ')}` : ''}
</div>`;
          }

          // Show detailed thinking - FULL content
          if (message.data.thinking) {
            thoughtContent += `

<div class="thinking-block">
<h4>üí≠ ${currentLang === 'es' ? 'Razonamiento Interno Completo' : 'Full Internal Reasoning'}</h4>
<div style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
${typeof message.data.thinking === 'object' ? JSON.stringify(message.data.thinking, null, 2) : message.data.thinking}
</div>
</div>`;
          }

          // Show actions if any - FULL details
          if (message.data.actions && message.data.actions.length > 0) {
            thoughtContent += `

<div class="actions-block">
<strong>üìã ${currentLang === 'es' ? 'Acciones Tomadas' : 'Actions Taken'}:</strong>
${message.data.actions.map(a => `
<div class="action-item" style="display: block; margin: 5px 0; padding: 8px;">
  <strong>${a.type}</strong>
  <pre style="margin: 5px 0; font-size: 0.7rem; overflow-x: auto;">${JSON.stringify(a.params || {}, null, 2)}</pre>
</div>`).join('')}
</div>`;
          }

          // Show message to others - FULL
          if (message.data.message) {
            thoughtContent += `

<div style="margin-top: 10px; padding: 10px; background: rgba(0, 212, 255, 0.1); border-radius: 6px;">
<strong>üí¨ ${currentLang === 'es' ? 'Mensaje a otros agentes' : 'Message to other agents'}:</strong>
<div style="white-space: pre-wrap; margin-top: 5px;">
${message.data.message}
</div>
</div>`;
          }

          addDeliberation(
            message.data.agentKey || getAgentKeyByName(message.data.agentName),
            thoughtContent,
            'thinking',
            message.data // Pass full data for logging
          );
          break;

        case 'theory_proposed':
          theories.push(message.data.theory);
          document.getElementById('theoriesCount').textContent = theories.length;
          updateTheoriesList();
          const theoryContent = `<strong>üìú ${currentLang === 'es' ? 'NUEVA TEOR√çA PROPUESTA' : 'NEW THEORY PROPOSED'}</strong>

<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-top: 10px;">
<h4 style="color: var(--accent-purple); margin-bottom: 10px;">${message.data.theory.name}</h4>

<strong>${currentLang === 'es' ? 'Descripci√≥n' : 'Description'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 15px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px;">
${message.data.theory.description || (currentLang === 'es' ? 'Sin descripci√≥n' : 'No description')}
</div>

<strong>${currentLang === 'es' ? 'Matem√°ticas' : 'Mathematics'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 15px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px; font-family: 'Courier New', monospace;">
${message.data.theory.mathematics || (currentLang === 'es' ? 'No especificado' : 'Not specified')}
</div>

<strong>${currentLang === 'es' ? 'Predicciones' : 'Predictions'}:</strong>
<pre style="margin: 5px 0 15px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px; overflow-x: auto;">
${JSON.stringify(message.data.theory.predictions || [], null, 2)}
</pre>

<strong>${currentLang === 'es' ? 'Tests Propuestos' : 'Proposed Tests'}:</strong>
<pre style="margin: 5px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px; overflow-x: auto;">
${JSON.stringify(message.data.theory.tests || [], null, 2)}
</pre>
</div>`;
          addDeliberation(
            message.data.agentKey || getAgentKeyByName(message.data.proposedBy),
            theoryContent,
            'theory',
            message.data
          );
          break;

        case 'theory_challenged':
          challengesCount++;
          document.getElementById('challengesCount').textContent = challengesCount;
          const challengeContent = `<strong>‚öîÔ∏è ${currentLang === 'es' ? 'DESAF√çO A' : 'CHALLENGE TO'}: ${message.data.theory?.name || 'Theory'}</strong>
<div style="font-size: 0.75rem; color: var(--text-secondary);">${currentLang === 'es' ? 'Propuesta por' : 'Proposed by'}: ${message.data.theoryAuthor || message.data.theory?.proposedBy || 'Unknown'}</div>

<div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 3px solid var(--accent-red);">

<strong>üß† ${currentLang === 'es' ? 'Razonamiento del D√©cimo Hombre' : 'Tenth Man Reasoning'}:</strong>
<div style="white-space: pre-wrap; margin: 10px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px; max-height: 300px; overflow-y: auto;">
${message.data.challenge?.reasoning || message.data.fullResponse?.thinking || (currentLang === 'es' ? 'Sin razonamiento detallado' : 'No detailed reasoning')}
</div>

<strong>üìù ${currentLang === 'es' ? 'Desaf√≠o/Objeciones' : 'Challenge/Objections'}:</strong>
<div style="white-space: pre-wrap; margin: 10px 0; padding: 10px; background: var(--bg-primary); border-radius: 5px;">
${message.data.challenge?.challenge || (currentLang === 'es' ? 'Sin detalles del desaf√≠o' : 'No challenge details')}
</div>

${message.data.challenge?.agreementLevel !== undefined ? `
<div style="margin-top: 10px;">
<strong>${currentLang === 'es' ? 'Nivel de Acuerdo' : 'Agreement Level'}:</strong>
<span style="color: ${message.data.challenge.agreementLevel < 30 ? 'var(--accent-red)' : message.data.challenge.agreementLevel < 70 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
${message.data.challenge.agreementLevel}%
</span>
</div>` : ''}
</div>`;
          addDeliberation(
            'tenthMan',
            challengeContent,
            'challenge',
            message.data
          );
          break;

        case 'tenth_man_analyzing':
          addDeliberation(
            'tenthMan',
            `<strong>üîç Analyzing theory:</strong> ${message.data.theory?.name || 'Unknown'}

Searching for flaws, hidden assumptions, and alternative explanations...`,
            'challenge'
          );
          break;

        case 'experiment_running':
          addDeliberation(
            getAgentKeyByName(message.data.agent),
            `<strong>üß™ RUNNING EXPERIMENT</strong>

<strong>Experiment:</strong> ${message.data.experiment}
Running simulation...`,
            'experiment'
          );
          break;

        case 'experiment_completed':
          experimentsCount++;
          document.getElementById('experimentsCount').textContent = experimentsCount;
          addDeliberation(
            getAgentKeyByName(message.data.agent),
            `<strong>‚úÖ EXPERIMENT COMPLETED</strong>

${JSON.stringify(message.data.experiment?.result || {}, null, 2).substring(0, 500)}...`,
            'experiment'
          );
          break;

        case 'agent_response':
          // Individual agent response in a conversation
          const responseContent = `<strong>‚Ü©Ô∏è ${currentLang === 'es' ? 'RESPUESTA DE' : 'RESPONSE FROM'} ${message.data.response?.agent}</strong>
<div style="font-size: 0.75rem; color: var(--text-secondary);">${currentLang === 'es' ? 'En respuesta a' : 'In response to'}: ${message.data.from}</div>

<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 8px;">

<strong>${currentLang === 'es' ? 'Mensaje Original' : 'Original Message'}:</strong>
<div style="font-style: italic; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px; font-size: 0.8rem;">
"${(message.data.originalMessage || '').substring(0, 200)}${message.data.originalMessage?.length > 200 ? '...' : ''}"
</div>

<strong>üß† ${currentLang === 'es' ? 'Razonamiento' : 'Reasoning'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px; max-height: 200px; overflow-y: auto;">
${message.data.response?.thinking || (currentLang === 'es' ? 'Sin razonamiento' : 'No reasoning')}
</div>

<strong>üí¨ ${currentLang === 'es' ? 'Respuesta' : 'Response'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px;">
${message.data.response?.response || (currentLang === 'es' ? 'Sin respuesta' : 'No response')}
</div>

${message.data.response?.agreementLevel !== undefined ? `
<strong>${currentLang === 'es' ? 'Nivel de Acuerdo' : 'Agreement Level'}:</strong>
<span style="color: ${message.data.response.agreementLevel < 30 ? 'var(--accent-red)' : message.data.response.agreementLevel < 70 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
${message.data.response.agreementLevel}%
</span>` : ''}
</div>`;
          addDeliberation(
            message.data.response?.agentKey || getAgentKeyByName(message.data.response?.agent),
            responseContent,
            'discussion',
            message.data
          );
          break;

        case 'discussion_message':
          // Individual message in a facilitated discussion
          const dmContent = `<strong>üí¨ ${message.data.from} ${currentLang === 'es' ? 'dice en discusi√≥n' : 'says in discussion'}:</strong>
<div style="font-size: 0.75rem; color: var(--text-secondary);">${currentLang === 'es' ? 'Tema' : 'Topic'}: ${(message.data.topic || '').substring(0, 100)}...</div>

<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 8px;">

<strong>üß† ${currentLang === 'es' ? 'Pensamiento' : 'Thinking'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px; max-height: 200px; overflow-y: auto;">
${message.data.message?.thinking || (currentLang === 'es' ? 'Sin pensamiento' : 'No thinking')}
</div>

<strong>üí¨ ${currentLang === 'es' ? 'Mensaje' : 'Message'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px;">
${message.data.message?.content || (currentLang === 'es' ? 'Sin mensaje' : 'No message')}
</div>

${message.data.message?.agreementLevel !== undefined ? `
<strong>${currentLang === 'es' ? 'Nivel de Acuerdo' : 'Agreement Level'}:</strong>
<span style="color: ${message.data.message.agreementLevel < 30 ? 'var(--accent-red)' : message.data.message.agreementLevel < 70 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">
${message.data.message.agreementLevel}%
</span>` : ''}
</div>`;
          addDeliberation(
            message.data.fromKey || getAgentKeyByName(message.data.from),
            dmContent,
            'discussion',
            message.data
          );
          break;

        case 'discussion':
          const discussionContent = `<strong>üí¨ ${currentLang === 'es' ? 'DISCUSI√ìN INICIADA' : 'DISCUSSION STARTED'}</strong>
<div style="font-size: 0.75rem; color: var(--text-secondary);">${currentLang === 'es' ? 'Iniciada por' : 'Started by'}: ${message.data.initiator}</div>

<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 8px;">
<strong>${currentLang === 'es' ? 'Tema' : 'Topic'}:</strong>
<div style="white-space: pre-wrap; margin: 5px 0 10px 0; padding: 8px; background: var(--bg-primary); border-radius: 5px;">
${message.data.topic || (currentLang === 'es' ? 'Sin tema' : 'No topic')}
</div>

<strong>${currentLang === 'es' ? 'Participantes' : 'Participants'}:</strong> ${message.data.participants?.join(', ') || 'Unknown'}
<strong>${currentLang === 'es' ? 'Mensajes' : 'Messages'}:</strong> ${message.data.messageCount || 0}
</div>`;
          addDeliberation(
            message.data.initiatorKey || getAgentKeyByName(message.data.initiator) || 'system',
            discussionContent,
            'discussion',
            message.data
          );
          break;

        case 'discussion_completed':
          const dcContent = `<strong>‚úÖ ${currentLang === 'es' ? 'DISCUSI√ìN COMPLETADA' : 'DISCUSSION COMPLETED'}</strong>

<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-top: 8px;">
<strong>${currentLang === 'es' ? 'Tema' : 'Topic'}:</strong> ${message.data.topic}
<strong>${currentLang === 'es' ? 'Iniciada por' : 'Initiated by'}:</strong> ${message.data.initiator}
<strong>${currentLang === 'es' ? 'Participantes' : 'Participants'}:</strong> ${message.data.participants?.join(', ')}
<strong>${currentLang === 'es' ? 'Total de mensajes' : 'Total messages'}:</strong> ${message.data.messageCount}

${message.data.allMessages && message.data.allMessages.length > 0 ? `
<details style="margin-top: 10px;">
<summary style="cursor: pointer; color: var(--accent-blue);">${currentLang === 'es' ? 'Ver todos los mensajes' : 'View all messages'} (${message.data.allMessages.length})</summary>
<div style="margin-top: 10px; max-height: 400px; overflow-y: auto;">
${message.data.allMessages.map((m, i) => `
<div style="padding: 10px; margin: 5px 0; background: var(--bg-primary); border-radius: 5px; border-left: 3px solid var(--accent-blue);">
<strong>${m.agent}</strong> <span style="font-size: 0.7rem; color: var(--text-secondary);">${m.personality || ''}</span>
${m.agreementLevel !== undefined ? `<span style="float: right; color: ${m.agreementLevel < 30 ? 'var(--accent-red)' : m.agreementLevel < 70 ? 'var(--accent-yellow)' : 'var(--accent-green)'};">${m.agreementLevel}%</span>` : ''}
<div style="white-space: pre-wrap; margin-top: 5px;">${m.content || m.response}</div>
</div>
`).join('')}
</div>
</details>` : ''}
</div>`;
          addDeliberation(
            'system',
            dcContent,
            'discussion',
            message.data
          );
          break;

        case 'discovery':
          discoveriesCount++;
          document.getElementById('discoveriesCount').textContent = discoveriesCount;
          addDeliberation(
            'system',
            `<strong>üéâ DISCOVERY!</strong>

${message.data.description || message.data.name || 'New insight found'}`,
            'discovery'
          );
          break;

        case 'auto_cycle_started':
          isAutoMode = true;
          autoBtn.textContent = '‚è∏ Stop Auto';
          break;

        case 'auto_cycle_stopped':
          isAutoMode = false;
          autoBtn.textContent = '‚èØ Auto';
          break;

        case 'error':
          addDeliberation('system', `ERROR: ${message.error}`, 'error', '‚ùå');
          break;
      }
    }

    function formatThinking(thinking) {
      if (!thinking) return 'No detailed thinking available';
      if (typeof thinking === 'object') {
        return JSON.stringify(thinking, null, 2);
      }
      return thinking.substring(0, 1000) + (thinking.length > 1000 ? '...' : '');
    }

    function getAgentKeyByName(name) {
      for (const [key, info] of Object.entries(agentInfo)) {
        if (info.name === name) return key;
      }
      return 'system';
    }

    function updateAgentThinking(agentName, isThinking) {
      const key = getAgentKeyByName(agentName);
      const card = document.querySelector(`[data-agent="${key}"]`);
      if (card) {
        card.classList.toggle('is-thinking', isThinking);
        if (isThinking) {
          const thinkingEl = card.querySelector('.agent-thinking');
          if (thinkingEl) thinkingEl.textContent = 'Processing...';
        }
      }
    }

    async function handleApiSubmit(e) {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Initializing...';

      try {
        const response = await fetch('/api/initialize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            deepseekApiKey: document.getElementById('deepseekKey').value,
            claudeApiKey: document.getElementById('claudeKey').value,
            openaiApiKey: document.getElementById('openaiKey').value
          })
        });

        const data = await response.json();

        if (data.success) {
          isInitialized = true;
          apiModal.classList.add('hidden');
          updateAgentsList(data.agents);
          systemStatus.className = 'status-dot active';
          statusText.textContent = 'Ready';
          updateButtons();
          clearFeed();
          addDeliberation('system', '‚úÖ System initialized with 10 agents. Click START to begin exploration!', 'session');
        } else {
          alert('Error: ' + data.error);
          btn.disabled = false;
          btn.innerHTML = 'Initialize System';
        }
      } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = 'Initialize System';
      }
    }

    function updateAgentsList(agents) {
      agentsList.innerHTML = agents.map(agent => {
        const info = agentInfo[agent.key] || { emoji: 'ü§ñ', color: '#888' };
        return `
          <div class="agent-card ${agent.key === 'tenthMan' ? 'tenth-man' : agent.key === 'synthesizer' ? 'synthesizer' : ''}" data-agent="${agent.key}">
            <div class="agent-header">
              <span class="agent-name">${info.emoji} ${agent.name}</span>
              <span class="agent-type ${agent.type}">${agent.type}</span>
            </div>
            <div class="agent-personality">${agent.personality}</div>
            <div class="agent-thinking">Idle</div>
          </div>
        `;
      }).join('');
    }

    function clearFeed() {
      deliberationFeed.innerHTML = '';
    }

    function addDeliberation(agentKey, content, type = 'info', rawData = null) {
      const info = agentInfo[agentKey] || { name: 'System', emoji: '‚öôÔ∏è', color: '#888', role: 'System' };

      // Log for download
      logDeliberation(agentKey, content, type, rawData);

      const item = document.createElement('div');
      item.className = `deliberation-item ${type}`;

      item.innerHTML = `
        <div class="deliberation-header">
          <div class="deliberation-agent">
            <div class="agent-avatar agent-${agentKey}" style="background: ${info.color};">
              ${info.emoji}
            </div>
            <div class="agent-info">
              <span class="name">${info.name}</span>
              <span class="role">${info.role}</span>
            </div>
            <span class="deliberation-type">${type}</span>
          </div>
          <span class="deliberation-time">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="deliberation-content">${content}</div>
      `;

      deliberationFeed.insertBefore(item, deliberationFeed.firstChild);

      // Keep more items visible (200 instead of 50)
      while (deliberationFeed.children.length > 200) {
        deliberationFeed.removeChild(deliberationFeed.lastChild);
      }
    }

    async function startSession() {
      const topic = topicSelect.value || 'Open Exploration';
      startBtn.disabled = true;

      try {
        const response = await fetch('/api/session/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic, language: currentLang })
        });

        const data = await response.json();
        if (data.success) {
          isRunning = true;
          updateButtons();
        }
      } catch (error) {
        console.error('Start error:', error);
        startBtn.disabled = false;
      }
    }

    async function runCycle() {
      cycleBtn.disabled = true;
      cycleBtn.innerHTML = '<span class="loading-spinner"></span> Running...';
      systemStatus.className = 'status-dot thinking';

      try {
        const response = await fetch('/api/cycle', { method: 'POST' });
        const data = await response.json();

        if (data.error) {
          addDeliberation('system', `Error in cycle: ${data.error}`, 'error', '‚ùå');
        }
      } catch (error) {
        addDeliberation('system', `Cycle error: ${error.message}`, 'error', '‚ùå');
      }

      cycleBtn.disabled = false;
      cycleBtn.innerHTML = '‚ü≥ Run Cycle';
      systemStatus.className = 'status-dot active';
    }

    function toggleAutoMode() {
      if (isAutoMode) {
        ws.send(JSON.stringify({ type: 'stop_auto' }));
      } else {
        ws.send(JSON.stringify({ type: 'start_auto', interval: 60000 }));
      }
    }

    async function stopSession() {
      try {
        await fetch('/api/session/stop', { method: 'POST' });
        isRunning = false;
        isAutoMode = false;
        updateButtons();
      } catch (error) {
        console.error('Stop error:', error);
      }
    }

    function updateButtons() {
      startBtn.disabled = !isInitialized || isRunning;
      cycleBtn.disabled = !isInitialized || !isRunning;
      autoBtn.disabled = !isInitialized || !isRunning;
      stopBtn.disabled = !isInitialized || !isRunning;
    }

    function updateState(state) {
      if (state) {
        isRunning = state.isRunning;
        cycleCount = state.cycleCount;
        cycleCountEl.textContent = cycleCount;
        document.getElementById('theoriesCount').textContent = state.theoriesCount || 0;
        document.getElementById('discoveriesCount').textContent = state.discoveriesCount || 0;
        updateButtons();
      }
    }

    function updateTheoriesList() {
      const list = document.getElementById('theoriesList');
      list.innerHTML = theories.slice().reverse().map(theory => `
        <div class="theory-card">
          <div class="theory-name">${theory.name}</div>
          <div class="theory-author">by ${theory.proposedBy}</div>
          <div class="theory-description">${(theory.description || '').substring(0, 150)}...</div>
          <span class="theory-status ${theory.status}">${theory.status}</span>
        </div>
      `).join('') || '<p style="color: var(--text-secondary); font-size: 0.8rem;">No theories yet</p>';
    }

    function switchTab(tabName) {
      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      document.getElementById('statsTab').style.display = tabName === 'stats' ? 'block' : 'none';
      document.getElementById('theoriesTab').style.display = tabName === 'theories' ? 'block' : 'none';
      document.getElementById('knowledgeTab').style.display = tabName === 'knowledge' ? 'block' : 'none';
    }

    // Change UI language
    async function changeLanguage(lang) {
      currentLang = lang;
      const t = uiText[lang];

      // Update language on server if system is initialized
      if (isInitialized) {
        try {
          await fetch('/api/language', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ language: lang })
          });
          console.log(`Language set on server: ${lang}`);

          // Add notification to feed
          const langNotice = lang === 'es'
            ? 'üåê <strong>Idioma cambiado a ESPA√ëOL</strong>\n\nLos agentes ahora deliberar√°n en espa√±ol.'
            : 'üåê <strong>Language changed to ENGLISH</strong>\n\nAgents will now deliberate in English.';
          addDeliberation('system', langNotice, 'session');
        } catch (error) {
          console.error('Error setting language:', error);
        }
      }

      // Header
      document.querySelector('.logo-text h1').textContent = t.title;
      document.getElementById('cycleLabel').textContent = t.cycle;

      // Status
      if (!isInitialized) {
        document.getElementById('statusText').textContent = t.notInitialized;
      } else if (isRunning) {
        document.getElementById('statusText').textContent = t.running;
      } else {
        document.getElementById('statusText').textContent = t.ready;
      }

      // Sidebar
      document.querySelector('.sidebar h2').textContent = `ü§ñ ${t.agents} (10)`;

      // Control buttons
      document.getElementById('startBtn').textContent = t.start;
      document.getElementById('cycleBtn').textContent = t.runCycle;
      document.getElementById('autoBtn').textContent = isAutoMode ? t.stopAuto : t.auto;
      document.getElementById('stopBtn').textContent = t.stop;

      // Topic select
      const topicSelect = document.getElementById('topicSelect');
      topicSelect.options[0].text = t.openExploration;
      topicSelect.options[1].text = t.darkMatter;
      topicSelect.options[2].text = t.quantumGravity;
      topicSelect.options[3].text = t.measurement;
      topicSelect.options[4].text = t.information;
      topicSelect.options[5].text = t.unification;

      // Panel tabs
      const tabs = document.querySelectorAll('.panel-tab');
      tabs[0].textContent = t.stats;
      tabs[1].textContent = t.theories;
      tabs[2].textContent = t.knowledge;

      // Stats labels
      document.querySelectorAll('.stat-label')[0].textContent = t.theoriesLabel;
      document.querySelectorAll('.stat-label')[1].textContent = t.discoveries;
      document.querySelectorAll('.stat-label')[2].textContent = t.challenges;
      document.querySelectorAll('.stat-label')[3].textContent = t.experiments;

      // Live status header
      const liveStatusHeader = document.querySelector('#statsTab h3');
      if (liveStatusHeader) liveStatusHeader.textContent = t.liveStatus;

      // Knowledge header
      const knowledgeHeader = document.querySelector('#knowledgeTab h3');
      if (knowledgeHeader) knowledgeHeader.textContent = t.unexplained;

      // Modal
      document.querySelector('.modal h2').textContent = `üî¨ ${t.initSystem}`;
      document.querySelector('.modal p').textContent = t.initDesc;
      document.querySelectorAll('.form-group label')[0].textContent = t.deepseekKey;
      document.querySelectorAll('.form-group label')[1].textContent = t.claudeKey;
      document.querySelectorAll('.form-group label')[2].textContent = t.openaiKey;
      document.querySelectorAll('.form-group small')[0].textContent = t.for9agents;
      document.querySelectorAll('.form-group small')[1].textContent = t.forTenthMan;
      document.querySelectorAll('.form-group small')[2].textContent = t.forSynthesizer;
      document.querySelector('.modal button[type="submit"]').textContent = t.initialize;

      // Welcome message if visible
      const welcomeTitle = deliberationFeed.querySelector('h3');
      if (welcomeTitle && welcomeTitle.textContent.includes('Welcome') || welcomeTitle && welcomeTitle.textContent.includes('Bienvenido')) {
        welcomeTitle.textContent = t.welcome;
        const welcomeDesc = deliberationFeed.querySelector('p');
        if (welcomeDesc) welcomeDesc.textContent = t.welcomeDesc;
        const howItWorks = deliberationFeed.querySelector('strong');
        if (howItWorks) howItWorks.textContent = t.howItWorks;
        const steps = deliberationFeed.querySelectorAll('li');
        if (steps.length >= 4) {
          steps[0].innerHTML = t.step1;
          steps[1].innerHTML = `${lang === 'es' ? 'Haz clic en' : 'Click'} <strong>${t.start.replace('‚ñ∂ ', '')}</strong> ${lang === 'es' ? 'para comenzar' : 'to begin a session'}`;
          steps[2].innerHTML = `${lang === 'es' ? 'Haz clic en' : 'Click'} <strong>${t.runCycle.replace('‚ü≥ ', '')}</strong> ${lang === 'es' ? 'para que los agentes piensen' : 'to make agents think'}`;
          steps[3].textContent = t.step4;
        }
      }

      // Save preference
      localStorage.setItem('physicsDiscoveryLang', lang);
    }

    // Load saved language on page load
    function loadSavedLanguage() {
      const savedLang = localStorage.getItem('physicsDiscoveryLang') || 'en';
      document.getElementById('langSelect').value = savedLang;
      if (savedLang !== 'en') {
        changeLanguage(savedLang);
      }
    }

    // Log deliberation for later download - NOW WITH FULL RAW DATA
    function logDeliberation(agentKey, content, type, rawData = null) {
      const info = agentInfo[agentKey] || { name: 'System', role: 'System' };
      fullDeliberationLog.push({
        timestamp: new Date().toISOString(),
        agent: info.name,
        agentKey: agentKey,
        role: info.role,
        type: type,
        content: content.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim(), // Strip HTML for text version
        contentHtml: content, // Keep HTML version too
        rawData: rawData, // Full raw data from the event
        // Extract key fields for easy access
        thinking: rawData?.thinking || rawData?.response?.thinking || rawData?.message?.thinking || rawData?.challenge?.reasoning || null,
        response: rawData?.response?.response || rawData?.message?.content || rawData?.challenge?.challenge || null,
        agreementLevel: rawData?.agreementLevel || rawData?.response?.agreementLevel || rawData?.message?.agreementLevel || rawData?.challenge?.agreementLevel || null,
        actions: rawData?.actions || rawData?.response?.actions || rawData?.message?.actions || [],
        focus: rawData?.focus || null,
        theoryName: rawData?.theory?.name || rawData?.theoryName || null
      });
    }

    // Download full report
    function downloadReport(lang = 'en') {
      const report = generateReport(lang);
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');

      // Create and download as markdown file
      const blob = new Blob([report], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `physics-discovery-report-${lang}-${timestamp}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Also download JSON with all raw data
      const jsonBlob = new Blob([JSON.stringify({
        meta: {
          language: lang,
          sessionStart: sessionStartTime,
          sessionEnd: new Date().toISOString(),
          totalCycles: cycleCount,
          totalTheories: theories.length,
          totalDiscoveries: discoveriesCount,
          totalChallenges: challengesCount,
          totalExperiments: experimentsCount
        },
        theories: theories,
        deliberations: fullDeliberationLog
      }, null, 2)], { type: 'application/json' });
      const jsonUrl = URL.createObjectURL(jsonBlob);
      const jsonA = document.createElement('a');
      jsonA.href = jsonUrl;
      jsonA.download = `physics-discovery-data-${timestamp}.json`;
      document.body.appendChild(jsonA);
      jsonA.click();
      document.body.removeChild(jsonA);
      URL.revokeObjectURL(jsonUrl);
    }

    function generateReport(lang = 'en') {
      const t = translations[lang];

      let report = `# ${t.title}

## ${t.sessionInfo}
- **${t.startTime}:** ${sessionStartTime || 'N/A'}
- **${t.endTime}:** ${new Date().toISOString()}
- **${t.totalCycles}:** ${cycleCount}
- **${t.totalTheories}:** ${theories.length}
- **${t.totalChallenges}:** ${challengesCount}
- **${t.totalExperiments}:** ${experimentsCount}
- **${t.totalDiscoveries}:** ${discoveriesCount}

---

## ${t.agents}

| ${t.agent} | ${t.type} | ${t.role} |
|-------|------|------|
| Euler | DeepSeek | ${t.roles.euler} |
| Faraday | DeepSeek | ${t.roles.faraday} |
| Democritus | DeepSeek | ${t.roles.democritus} |
| Hubble | DeepSeek | ${t.roles.hubble} |
| Shannon | DeepSeek | ${t.roles.shannon} |
| Boltzmann | DeepSeek | ${t.roles.boltzmann} |
| Bohr | DeepSeek | ${t.roles.bohr} |
| Einstein | DeepSeek | ${t.roles.einstein} |
| Anderson | DeepSeek | ${t.roles.anderson} |
| **Advocatus Diaboli** | **Claude Opus 4.5** | **${t.roles.tenthMan}** |
| **Nexus** | **GPT-5.2** | **${t.roles.synthesizer}** |

---

## ${t.theoriesProposed}

`;

      theories.forEach((theory, i) => {
        report += `### ${i + 1}. ${theory.name}
- **${t.proposedBy}:** ${theory.proposedBy}
- **${t.status}:** ${theory.status}
- **${t.description}:** ${theory.description || 'N/A'}
- **${t.mathematics}:** ${theory.mathematics || 'N/A'}
- **${t.predictions}:** ${JSON.stringify(theory.predictions || [])}
- **${t.challenges}:** ${theory.challenges?.length || 0}

`;
      });

      report += `---

## ${t.deliberationLog}

`;

      fullDeliberationLog.forEach((entry, i) => {
        report += `### [${entry.timestamp}] ${entry.agent} (${entry.type})

**${lang === 'es' ? 'Rol' : 'Role'}:** ${entry.role}
${entry.focus ? `**${lang === 'es' ? 'Enfoque' : 'Focus'}:** ${entry.focus}` : ''}
${entry.theoryName ? `**${lang === 'es' ? 'Teor√≠a' : 'Theory'}:** ${entry.theoryName}` : ''}
${entry.agreementLevel !== null ? `**${lang === 'es' ? 'Nivel de Acuerdo' : 'Agreement Level'}:** ${entry.agreementLevel}%` : ''}

${entry.thinking ? `#### ${lang === 'es' ? 'Razonamiento' : 'Reasoning'}:
\`\`\`
${typeof entry.thinking === 'object' ? JSON.stringify(entry.thinking, null, 2) : entry.thinking}
\`\`\`
` : ''}

${entry.response ? `#### ${lang === 'es' ? 'Respuesta' : 'Response'}:
${entry.response}
` : ''}

${entry.actions && entry.actions.length > 0 ? `#### ${lang === 'es' ? 'Acciones' : 'Actions'}:
\`\`\`json
${JSON.stringify(entry.actions, null, 2)}
\`\`\`
` : ''}

${entry.content && !entry.thinking && !entry.response ? `#### ${lang === 'es' ? 'Contenido' : 'Content'}:
${entry.content}
` : ''}

---

`;
      });

      report += `

## ${t.summaryStats}

- ${t.totalEntries}: ${fullDeliberationLog.length}
- ${t.agentsParticipated}: ${[...new Set(fullDeliberationLog.map(d => d.agent))].join(', ')}

---

*${t.footer}*
*9 DeepSeek Agents + 1 Claude Opus 4.5 (${t.tenthManLabel}) + 1 GPT-5.2 (${t.synthesizerLabel})*
`;

      return report;
    }

    // Translations
    const translations = {
      en: {
        title: "Physics Discovery Multi-Agent Report",
        sessionInfo: "Session Information",
        startTime: "Start Time",
        endTime: "End Time",
        totalCycles: "Total Cycles",
        totalTheories: "Total Theories Proposed",
        totalChallenges: "Total Challenges (Tenth Man)",
        totalExperiments: "Total Experiments",
        totalDiscoveries: "Total Discoveries",
        agents: "Agents",
        agent: "Agent",
        type: "Type",
        role: "Role",
        roles: {
          euler: "Mathematical purist - seeks elegant structures",
          faraday: "Empirical pragmatist - demands verification",
          democritus: "Particle reductionist - fundamental building blocks",
          hubble: "Cosmic visionary - universal perspective",
          shannon: "Information theorist - information is fundamental",
          boltzmann: "Statistical thinker - probability explains all",
          bohr: "Quantum philosopher - measurement mystery",
          einstein: "Grand unifier - seeks unified theories",
          anderson: "Emergence champion - 'more is different'",
          tenthMan: "THE TENTH MAN - Devil's Advocate",
          synthesizer: "THE SYNTHESIZER - Pattern Connector"
        },
        theoriesProposed: "Theories Proposed",
        proposedBy: "Proposed by",
        status: "Status",
        description: "Description",
        mathematics: "Mathematics",
        predictions: "Predictions",
        challenges: "Challenges",
        deliberationLog: "Full Deliberation Log",
        summaryStats: "Summary Statistics",
        totalEntries: "Total deliberation entries",
        agentsParticipated: "Agents participated",
        footer: "Report generated by Physics Discovery Multi-Agent System",
        tenthManLabel: "Tenth Man",
        synthesizerLabel: "Synthesizer"
      },
      es: {
        title: "Informe del Sistema Multi-Agente de Descubrimiento F√≠sico",
        sessionInfo: "Informaci√≥n de la Sesi√≥n",
        startTime: "Hora de Inicio",
        endTime: "Hora de Fin",
        totalCycles: "Ciclos Totales",
        totalTheories: "Teor√≠as Propuestas",
        totalChallenges: "Desaf√≠os del D√©cimo Hombre",
        totalExperiments: "Experimentos Realizados",
        totalDiscoveries: "Descubrimientos",
        agents: "Agentes",
        agent: "Agente",
        type: "Tipo",
        role: "Rol",
        roles: {
          euler: "Purista matem√°tico - busca estructuras elegantes",
          faraday: "Pragm√°tico emp√≠rico - exige verificaci√≥n experimental",
          democritus: "Reduccionista de part√≠culas - busca bloques fundamentales",
          hubble: "Visionario c√≥smico - perspectiva universal",
          shannon: "Te√≥rico de informaci√≥n - la informaci√≥n es fundamental",
          boltzmann: "Pensador estad√≠stico - la probabilidad lo explica todo",
          bohr: "Fil√≥sofo cu√°ntico - el misterio de la medici√≥n",
          einstein: "Gran unificador - busca teor√≠as unificadas",
          anderson: "Campe√≥n de la emergencia - 'm√°s es diferente'",
          tenthMan: "EL D√âCIMO HOMBRE - Abogado del Diablo",
          synthesizer: "EL SINTETIZADOR - Conector de Patrones"
        },
        theoriesProposed: "Teor√≠as Propuestas",
        proposedBy: "Propuesta por",
        status: "Estado",
        description: "Descripci√≥n",
        mathematics: "Matem√°ticas",
        predictions: "Predicciones",
        challenges: "Desaf√≠os",
        deliberationLog: "Registro Completo de Deliberaciones",
        summaryStats: "Estad√≠sticas Resumen",
        totalEntries: "Total de entradas de deliberaci√≥n",
        agentsParticipated: "Agentes que participaron",
        footer: "Informe generado por el Sistema Multi-Agente de Descubrimiento F√≠sico",
        tenthManLabel: "D√©cimo Hombre",
        synthesizerLabel: "Sintetizador"
      }
    };
  </script>
</body>
</html>
