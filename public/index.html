<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physics Discovery - 9 Legendary Physicists</title>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --accent-blue: #00d4ff;
      --accent-purple: #a855f7;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-yellow: #eab308;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --border-color: #2d2d3a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo { display: flex; align-items: center; gap: 12px; }

    .logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }

    .logo h1 {
      font-size: 1.2rem;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status {
      display: flex; gap: 15px; align-items: center;
    }

    .status-item {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 0.85rem;
    }

    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--accent-red);
    }

    .status-dot.ready { background: var(--accent-green); }
    .status-dot.running { background: var(--accent-yellow); animation: pulse 1s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .main { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 70px); }

    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      padding: 15px;
    }

    .sidebar h2 {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .agent-card {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 3px solid var(--accent-blue);
      transition: all 0.3s;
    }

    .agent-card.devil { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
    .agent-card.thinking { border-left-color: var(--accent-yellow); }
    .agent-card.done { border-left-color: var(--accent-green); }

    .agent-name { font-weight: bold; font-size: 0.85rem; }
    .agent-era { font-size: 0.7rem; color: var(--text-secondary); }
    .agent-status { font-size: 0.7rem; margin-top: 5px; color: var(--accent-yellow); display: none; }
    .agent-card.thinking .agent-status { display: block; }

    .content { display: flex; flex-direction: column; overflow: hidden; }

    .controls {
      padding: 15px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
    }

    .btn.primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .topic-input {
      flex: 1;
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: white;
      font-family: inherit;
    }

    .feed {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-blue);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .message.system { border-left-color: var(--accent-purple); }
    .message.theory { border-left-color: var(--accent-green); }
    .message.devil { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
    .message.discovery { border-left-color: var(--accent-yellow); background: rgba(234, 179, 8, 0.1); }
    .message.complete { border-left-color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .message-agent { font-weight: bold; color: var(--accent-blue); }
    .message.devil .message-agent { color: var(--accent-red); }
    .message-time { font-size: 0.7rem; color: var(--text-secondary); }

    .message-content { font-size: 0.85rem; line-height: 1.6; white-space: pre-wrap; }

    .theory-block {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }

    .theory-name { color: var(--accent-purple); font-weight: bold; margin-bottom: 8px; }
    .theory-desc { font-size: 0.8rem; margin-bottom: 8px; }
    .theory-math { font-family: monospace; background: var(--bg-primary); padding: 8px; border-radius: 5px; font-size: 0.75rem; }

    .agreement { margin-top: 10px; font-size: 0.8rem; }
    .agreement-value { font-weight: bold; }
    .agreement-value.high { color: var(--accent-green); }
    .agreement-value.medium { color: var(--accent-yellow); }
    .agreement-value.low { color: var(--accent-red); }

    .summary {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 20px;
      margin-top: 10px;
    }

    .summary h3 { color: var(--accent-green); margin-bottom: 15px; }
    .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .summary-item { text-align: center; }
    .summary-value { font-size: 1.5rem; font-weight: bold; color: var(--accent-blue); }
    .summary-label { font-size: 0.75rem; color: var(--text-secondary); }

    .welcome {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .welcome-icon { font-size: 4rem; margin-bottom: 20px; }
    .welcome h2 { color: var(--text-primary); margin-bottom: 10px; }
    .welcome p { max-width: 500px; margin: 0 auto; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">&#9883;</div>
      <div>
        <h1>Physics Discovery</h1>
        <div style="font-size: 0.7rem; color: var(--text-secondary);">9 Legendary Physicists + Devil's Advocate</div>
      </div>
    </div>
    <div class="status">
      <div class="status-item">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Initializing...</span>
      </div>
      <div class="status-item">
        Theories: <strong id="theoriesCount">0</strong>
      </div>
      <div class="status-item">
        Discoveries: <strong id="discoveriesCount">0</strong>
      </div>
    </div>
  </header>

  <div class="main">
    <aside class="sidebar">
      <h2>Physicists (10)</h2>
      <div id="agentsList"></div>
    </aside>

    <main class="content">
      <div class="controls">
        <input type="text" class="topic-input" id="topicInput" placeholder="Enter topic to explore (or leave empty for default)">
        <button class="btn primary" id="startBtn" disabled>START EXPLORATION</button>
      </div>

      <div class="feed" id="feed">
        <div class="welcome">
          <div class="welcome-icon">&#128301;</div>
          <h2>Welcome to Physics Discovery</h2>
          <p>Click START to summon 9 legendary physicists + the Devil's Advocate. They will all think in PARALLEL and propose theories about the fundamental nature of reality.</p>
          <p style="margin-top: 15px;"><strong>Discovery requires 95% consensus</strong> (9 out of 9 physicists must agree)</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Agent info
    const agents = {
      newton: { name: 'Isaac Newton', era: '1643-1727', emoji: '&#127822;' },
      einstein: { name: 'Albert Einstein', era: '1879-1955', emoji: '&#127756;' },
      feynman: { name: 'Richard Feynman', era: '1918-1988', emoji: '&#12336;&#65039;' },
      bohr: { name: 'Niels Bohr', era: '1885-1962', emoji: '&#9883;&#65039;' },
      dirac: { name: 'Paul Dirac', era: '1902-1984', emoji: '&#10133;&#10134;' },
      boltzmann: { name: 'Ludwig Boltzmann', era: '1844-1906', emoji: '&#127922;' },
      hawking: { name: 'Stephen Hawking', era: '1942-2018', emoji: '&#128371;&#65039;' },
      noether: { name: 'Emmy Noether', era: '1882-1935', emoji: '&#9854;&#65039;' },
      wheeler: { name: 'John A. Wheeler', era: '1911-2008', emoji: '&#128161;' },
      devils_advocate: { name: 'Advocatus Diaboli', era: 'Eternal', emoji: '&#128121;', isDevil: true }
    };

    // State
    let ws = null;
    let isInitialized = false;
    let isRunning = false;

    // DOM
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const startBtn = document.getElementById('startBtn');
    const topicInput = document.getElementById('topicInput');
    const feed = document.getElementById('feed');
    const agentsList = document.getElementById('agentsList');
    const theoriesCount = document.getElementById('theoriesCount');
    const discoveriesCount = document.getElementById('discoveriesCount');

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      renderAgents();
      connectWebSocket();
      await initialize();
    });

    function renderAgents() {
      agentsList.innerHTML = Object.entries(agents).map(([key, agent]) => `
        <div class="agent-card ${agent.isDevil ? 'devil' : ''}" id="agent-${key}">
          <div class="agent-name">${agent.emoji} ${agent.name}</div>
          <div class="agent-era">${agent.era}</div>
          <div class="agent-status">Thinking...</div>
        </div>
      `).join('');
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}`);

      ws.onopen = () => console.log('WebSocket connected');
      ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
      ws.onclose = () => setTimeout(connectWebSocket, 2000);
    }

    async function initialize() {
      try {
        const res = await fetch('/api/initialize', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          isInitialized = true;
          statusDot.classList.add('ready');
          statusText.textContent = 'Ready';
          startBtn.disabled = false;
        }
      } catch (err) {
        statusText.textContent = 'Error: ' + err.message;
      }
    }

    startBtn.addEventListener('click', async () => {
      if (isRunning) return;

      const topic = topicInput.value || undefined;
      startBtn.disabled = true;
      isRunning = true;
      statusDot.classList.remove('ready');
      statusDot.classList.add('running');
      statusText.textContent = 'Running...';

      // Clear welcome
      feed.innerHTML = '';

      try {
        await fetch('/api/explore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic })
        });
      } catch (err) {
        addMessage('system', 'Error: ' + err.message, 'system');
        isRunning = false;
        startBtn.disabled = false;
      }
    });

    function handleMessage(msg) {
      console.log('WS:', msg.type, msg.data);

      switch (msg.type) {
        case 'exploration_started':
          addMessage('system', `Exploration started: ${msg.data.topic}\n\nAll 10 physicists are thinking IN PARALLEL...`, 'system');
          break;

        case 'agent_thinking':
          const thinkCard = document.getElementById(`agent-${msg.data.agentKey}`);
          if (thinkCard) thinkCard.classList.add('thinking');
          break;

        case 'agent_result':
          const doneCard = document.getElementById(`agent-${msg.data.agentKey}`);
          if (doneCard) {
            doneCard.classList.remove('thinking');
            doneCard.classList.add('done');
          }

          const result = msg.data.result;
          if (!result || !result.success) {
            addMessage(msg.data.agentName, `Error in reasoning process`, msg.data.isDevil ? 'devil' : 'theory');
            return;
          }

          let content = '';

          if (result.thinking) {
            content += `<strong>Thinking:</strong>\n${result.thinking}\n\n`;
          }

          if (result.theory) {
            content += `<div class="theory-block">
              <div class="theory-name">${result.theory.name}</div>
              <div class="theory-desc">${result.theory.description || ''}</div>
              ${result.theory.mathematics ? `<div class="theory-math">${result.theory.mathematics}</div>` : ''}
            </div>`;
          }

          const agreementClass = result.agreement >= 70 ? 'high' : result.agreement >= 40 ? 'medium' : 'low';
          content += `<div class="agreement">Agreement: <span class="agreement-value ${agreementClass}">${result.agreement}%</span></div>`;

          addMessage(msg.data.agentName, content, msg.data.isDevil ? 'devil' : 'theory');
          break;

        case 'discovery':
          discoveriesCount.textContent = parseInt(discoveriesCount.textContent) + 1;
          addMessage('DISCOVERY!', `
            <strong>${msg.data.theory.name}</strong> has achieved ${msg.data.consensusPercent.toFixed(1)}% consensus!
            <div class="theory-block">
              <div class="theory-desc">${msg.data.theory.description}</div>
            </div>
          `, 'discovery');
          break;

        case 'exploration_complete':
          theoriesCount.textContent = msg.data.theories;

          let summaryHtml = `<div class="summary">
            <h3>Exploration Complete</h3>
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-value">${msg.data.theories}</div>
                <div class="summary-label">Theories</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${msg.data.avgAgreement}%</div>
                <div class="summary-label">Avg Agreement</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${msg.data.agreeCount}/9</div>
                <div class="summary-label">Consensus</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${msg.data.isDiscovery ? 'YES!' : 'No'}</div>
                <div class="summary-label">Discovery</div>
              </div>
            </div>
          </div>`;

          addMessage('system', summaryHtml, 'complete');

          // Reset state
          isRunning = false;
          startBtn.disabled = false;
          statusDot.classList.remove('running');
          statusDot.classList.add('ready');
          statusText.textContent = 'Ready';

          // Reset agent cards
          document.querySelectorAll('.agent-card').forEach(card => {
            card.classList.remove('thinking', 'done');
          });
          break;

        case 'agent_error':
          addMessage(msg.data.agentName, `Error: ${msg.data.error}`, 'devil');
          break;
      }
    }

    function addMessage(agent, content, type = 'info') {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.innerHTML = `
        <div class="message-header">
          <span class="message-agent">${agent}</span>
          <span class="message-time">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="message-content">${content}</div>
      `;
      feed.insertBefore(div, feed.firstChild);
    }
  </script>
</body>
</html>
