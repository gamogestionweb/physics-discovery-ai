<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>PCP Universe - Simulaci√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { background: #0a0a18; color: #fff; font-family: 'Segoe UI', sans-serif; }

        .main { display: flex; height: 100vh; }
        .world { width: 60%; height: 100%; position: relative; }
        #canvas { width: 100%; height: 100%; }

        #panel {
            width: 40%;
            height: 100vh;
            background: linear-gradient(180deg, #100818 0%, #0a0610 100%);
            border-left: 2px solid #6030a0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 15px;
            background: #180820;
            border-bottom: 1px solid #402060;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 { color: #a060ff; font-size: 14px; font-weight: normal; }

        .tabs {
            display: flex;
            background: #0c0610;
            border-bottom: 1px solid #402060;
        }
        .tab {
            padding: 10px 14px;
            cursor: pointer;
            color: #556;
            font-size: 11px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab.active { color: #a060ff; border-bottom-color: #a060ff; }
        .tab:hover { color: #c080ff; }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: none;
        }
        .tab-content.active { display: block; }

        /* Pensamiento */
        .thought-card {
            background: rgba(80, 40, 120, 0.25);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #8040c0;
        }
        .thought-time { color: #8060a0; font-size: 10px; margin-bottom: 6px; }
        .thought-text { color: #d0c0e0; font-size: 12px; line-height: 1.5; }
        .thought-action {
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(100, 60, 160, 0.3);
            border-radius: 4px;
            font-size: 11px;
            color: #c080ff;
        }
        .pcp-insight {
            margin-top: 8px;
            padding: 8px;
            background: rgba(60, 180, 120, 0.2);
            border-radius: 4px;
            font-size: 11px;
            color: #60e0a0;
            border-left: 2px solid #40c080;
        }

        /* Leyes */
        .law-card {
            background: linear-gradient(135deg, rgba(40, 100, 80, 0.4) 0%, rgba(30, 80, 60, 0.3) 100%);
            padding: 14px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #40c080;
        }
        .law-name { color: #60e0a0; font-size: 14px; font-weight: bold; margin-bottom: 6px; }
        .law-formula {
            font-family: 'Courier New', monospace;
            color: #a0ffc0;
            font-size: 16px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin: 8px 0;
        }
        .law-novelty { color: #80e0c0; font-size: 11px; font-style: italic; margin-top: 6px; }
        .law-confidence {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(60, 180, 100, 0.3);
            border-radius: 10px;
            font-size: 10px;
            color: #80e0a0;
            margin-top: 6px;
        }

        /* PCP Insights */
        .insight-card {
            background: rgba(40, 120, 100, 0.3);
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 3px solid #40c0a0;
        }
        .insight-obs { color: #a0ffd0; font-size: 12px; }
        .insight-impl { color: #60a080; font-size: 11px; margin-top: 6px; font-style: italic; }

        /* Hip√≥tesis */
        .hypothesis-card {
            background: rgba(100, 80, 40, 0.3);
            padding: 10px;
            margin: 6px 0;
            border-radius: 6px;
            border-left: 3px solid #c0a040;
        }
        .hypothesis-text { color: #e0d0a0; font-size: 12px; }
        .hypothesis-test { color: #a09060; font-size: 10px; margin-top: 4px; font-style: italic; }

        /* Correlaciones */
        .corr-card {
            background: rgba(100, 40, 120, 0.3);
            padding: 10px;
            margin: 6px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .corr-objects { color: #d0a0ff; font-size: 12px; }
        .corr-type { color: #a080c0; font-size: 10px; }
        .corr-strength {
            background: rgba(150, 80, 200, 0.5);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            color: #e0c0ff;
        }

        /* Experimentos */
        .exp-card {
            background: rgba(50, 40, 80, 0.3);
            padding: 8px 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 11px;
        }
        .exp-time { color: #7060a0; }
        .exp-action { color: #b0a0e0; font-weight: bold; }
        .exp-result { color: #9080b0; margin-top: 4px; }

        /* HUD */
        #hud {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-70%);
            background: rgba(20, 10, 40, 0.95);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            color: #c080ff;
            border: 1px solid #503080;
            display: flex;
            gap: 15px;
        }
        .hud-item { display: flex; align-items: center; gap: 5px; }
        .hud-label { color: #7050a0; font-size: 9px; }
        .hud-value { color: #c0a0ff; font-weight: bold; }
        .hud-entropy { color: #60e0a0; }

        /* Controles */
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        #controls button {
            background: rgba(40, 20, 60, 0.95);
            color: #a060ff;
            border: 1px solid #604090;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 11px;
        }
        #controls button:hover { background: rgba(60, 30, 90, 0.95); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .stat-box {
            background: rgba(50, 30, 80, 0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number { font-size: 24px; color: #a060ff; font-weight: bold; }
        .stat-label { font-size: 9px; color: #8060a0; margin-top: 5px; }

        /* Info Object */
        .info-obj {
            background: rgba(60, 40, 100, 0.3);
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
        }
        .info-obj-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .info-obj-name { color: #c0a0ff; font-weight: bold; }
        .info-obj-coherence {
            background: rgba(60, 180, 120, 0.4);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        .info-bar {
            height: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            margin: 4px 0;
            overflow: hidden;
        }
        .info-bar-fill { height: 100%; border-radius: 3px; }

        /* Modal Informe */
        #reportModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
        }
        #reportContent {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background: #100818;
            border: 2px solid #6030a0;
            border-radius: 12px;
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #402060;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .report-header h1 { color: #a060ff; font-size: 22px; }
        .report-section {
            background: rgba(40, 20, 70, 0.4);
            padding: 18px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 3px solid #8040c0;
        }
        .report-section h3 { color: #a060ff; margin-bottom: 12px; font-size: 14px; }
        .report-section p { color: #c0b0d0; font-size: 12px; line-height: 1.6; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0610; }
        ::-webkit-scrollbar-thumb { background: #402060; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #503080; }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="sim.reset()">Reset</button>
        <button onclick="sim.generateReport()">INFORME PCP</button>
    </div>

    <div id="hud">
        <div class="hud-item">
            <span class="hud-label">TIEMPO</span>
            <span class="hud-value" id="timeValue">0.0s</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">ENTROP√çA</span>
            <span class="hud-value hud-entropy" id="entropyValue">0.00</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">INSIGHTS</span>
            <span class="hud-value" id="insightsCount">0</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">CORRELACIONES</span>
            <span class="hud-value" id="corrCount">0</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">LEYES</span>
            <span class="hud-value" id="lawsCount">0</span>
        </div>
    </div>

    <div class="main">
        <div class="world">
            <canvas id="canvas"></canvas>
        </div>

        <div id="panel">
            <div class="panel-header">
                <h2>üåå PCP UNIVERSE - Present Containment Principle</h2>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="mind">Pensamiento</div>
                <div class="tab" data-tab="laws">Descubrimientos</div>
                <div class="tab" data-tab="correlations">Correlaciones</div>
                <div class="tab" data-tab="objects">Info Objetos</div>
                <div class="tab" data-tab="experiments">Experimentos</div>
            </div>

            <div id="mind-tab" class="tab-content active"></div>
            <div id="laws-tab" class="tab-content"></div>
            <div id="correlations-tab" class="tab-content"></div>
            <div id="objects-tab" class="tab-content"></div>
            <div id="experiments-tab" class="tab-content"></div>
        </div>
    </div>

    <div id="reportModal">
        <div id="reportContent"></div>
    </div>

<script>
const WORLD_WIDTH = 1200;
const WORLD_HEIGHT = 400;

let state = {
    agent: {x:200,y:0,informationBudget:1000},
    objects: [],
    pendulum: {angle:0},
    fluid: {x:700,width:150},
    entropy: 0,
    correlations: []
};
let laws = { discovered: [], hypotheses: [], pcpInsights: [] };
let thoughts = [];
let experiments = [];

const sim = {
    canvas: null,
    ctx: null,

    init() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.onresize = () => this.resize();

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            };
        });

        this.fetchData();
        requestAnimationFrame(() => this.loop());
        setInterval(() => this.fetchData(), 1000);
        setInterval(() => this.updateUI(), 500);
    },

    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
    },

    async fetchData() {
        try {
            const [stateRes, lawsRes, thoughtsRes, expRes] = await Promise.all([
                fetch('/state'),
                fetch('/laws'),
                fetch('/thoughts'),
                fetch('/experiments')
            ]);
            state = await stateRes.json();
            laws = await lawsRes.json();
            thoughts = await thoughtsRes.json();
            experiments = await expRes.json();
        } catch(e) {
            console.error('Fetch error:', e);
        }
    },

    loop() {
        this.render();
        requestAnimationFrame(() => this.loop());
    },

    render() {
        const c = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;

        // Fondo con gradiente p√∫rpura oscuro
        const grad = c.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, '#0a0818');
        grad.addColorStop(1, '#050410');
        c.fillStyle = grad;
        c.fillRect(0, 0, w, h);

        // Grid informacional
        c.strokeStyle = 'rgba(80, 40, 120, 0.15)';
        c.lineWidth = 1;
        for(let x = 0; x < w; x += 40) {
            c.beginPath();
            c.moveTo(x, 0);
            c.lineTo(x, h);
            c.stroke();
        }
        for(let y = 0; y < h; y += 40) {
            c.beginPath();
            c.moveTo(0, y);
            c.lineTo(w, y);
            c.stroke();
        }

        const groundY = h - 80;
        const scale = w / WORLD_WIDTH;

        // Suelo
        c.fillStyle = '#1a1028';
        c.fillRect(0, groundY, w, h - groundY);
        c.strokeStyle = '#6040a0';
        c.lineWidth = 2;
        c.beginPath();
        c.moveTo(0, groundY);
        c.lineTo(w, groundY);
        c.stroke();

        // Visualizar correlaciones como l√≠neas
        for(const corr of state.correlations || []) {
            if(corr.type === 'interaction-induced' || corr.type === 'entanglement') {
                const obj1 = (state.objects || []).find(o => o.id === corr.objects[0]);
                const obj2 = (state.objects || []).find(o => o.id === corr.objects[1]);
                if(obj1 && obj2) {
                    const x1 = obj1.x * scale;
                    const y1 = groundY - 20 - obj1.y * 3;
                    const x2 = obj2.x * scale;
                    const y2 = groundY - 20 - obj2.y * 3;

                    c.strokeStyle = `rgba(160, 80, 255, ${corr.strength * 0.6})`;
                    c.lineWidth = corr.strength * 3;
                    c.setLineDash([5, 5]);
                    c.beginPath();
                    c.moveTo(x1, y1);
                    c.lineTo(x2, y2);
                    c.stroke();
                    c.setLineDash([]);
                }
            }
        }

        // Tanque de agua
        const fluidX = state.fluid?.x * scale || 700;
        const fluidW = (state.fluid?.width || 150) * scale;
        c.fillStyle = 'rgba(40, 100, 180, 0.4)';
        c.fillRect(fluidX, groundY - 80, fluidW, 80);
        c.strokeStyle = 'rgba(60, 130, 220, 0.6)';
        c.strokeRect(fluidX, groundY - 80, fluidW, 80);
        c.fillStyle = '#4090d0';
        c.font = '10px sans-serif';
        c.textAlign = 'center';
        c.fillText('FLUIDO (œÅ=1000)', fluidX + fluidW/2, groundY - 85);

        // P√©ndulo
        if(state.pendulum) {
            const pivotX = 350 * scale;
            const pivotY = h * 0.3;
            const L = 120;
            const angle = state.pendulum.angle || 0;
            const bobX = pivotX + Math.sin(angle) * L;
            const bobY = pivotY + Math.cos(angle) * L;

            c.fillStyle = '#403050';
            c.fillRect(pivotX - 30, pivotY - 10, 60, 10);

            c.strokeStyle = '#605070';
            c.lineWidth = 2;
            c.beginPath();
            c.moveTo(pivotX, pivotY);
            c.lineTo(bobX, bobY);
            c.stroke();

            c.fillStyle = '#a06080';
            c.beginPath();
            c.arc(bobX, bobY, 15, 0, Math.PI * 2);
            c.fill();

            c.fillStyle = '#c0a0b0';
            c.font = '10px sans-serif';
            c.textAlign = 'center';
            c.fillText(`Œ∏=${(angle * 180 / Math.PI).toFixed(1)}¬∞`, pivotX, pivotY - 18);
        }

        // Objetos con visualizaci√≥n de coherencia
        for(const obj of state.objects || []) {
            if(obj.held) continue;

            const ox = obj.x * scale;
            const oy = groundY - 20 - obj.y * 3;
            const coherence = obj.coherence || 1;
            const scrambling = obj.scrambledPhase || 0;

            // Aura de coherencia
            const auraRadius = 25 + scrambling * 10;
            const auraGrad = c.createRadialGradient(ox, oy, 5, ox, oy, auraRadius);
            auraGrad.addColorStop(0, `rgba(100, 200, 150, ${coherence * 0.3})`);
            auraGrad.addColorStop(1, 'rgba(100, 200, 150, 0)');
            c.fillStyle = auraGrad;
            c.beginPath();
            c.arc(ox, oy, auraRadius, 0, Math.PI * 2);
            c.fill();

            // Sombra
            c.fillStyle = 'rgba(0,0,0,0.3)';
            c.beginPath();
            c.ellipse(ox, groundY - 2, 12, 4, 0, 0, Math.PI * 2);
            c.fill();

            // Objeto
            c.fillStyle = obj.color || '#808080';
            c.beginPath();
            c.arc(ox, oy, (obj.radius || 15) * 0.8, 0, Math.PI * 2);
            c.fill();

            // Borde de coherencia
            c.strokeStyle = `rgba(100, 255, 180, ${coherence})`;
            c.lineWidth = 2;
            c.beginPath();
            c.arc(ox, oy, (obj.radius || 15) * 0.8 + 2, 0, Math.PI * 2);
            c.stroke();

            // Etiqueta
            c.fillStyle = '#c0a0e0';
            c.font = '9px sans-serif';
            c.textAlign = 'center';
            c.fillText(obj.id, ox, oy - 22);
            c.fillStyle = '#8060a0';
            c.fillText(`${obj.mass}kg | œà:${coherence.toFixed(2)}`, ox, oy - 12);
        }

        // Agente
        if(state.agent) {
            const ax = state.agent.x * scale;
            const ay = groundY - 50 - (state.agent.y || 0) * 3;

            // Aura informacional del agente
            const agentAura = c.createRadialGradient(ax, ay + 20, 10, ax, ay + 20, 60);
            agentAura.addColorStop(0, 'rgba(160, 80, 255, 0.2)');
            agentAura.addColorStop(1, 'rgba(160, 80, 255, 0)');
            c.fillStyle = agentAura;
            c.beginPath();
            c.arc(ax, ay + 20, 60, 0, Math.PI * 2);
            c.fill();

            // Sombra
            c.fillStyle = 'rgba(0,0,0,0.4)';
            c.beginPath();
            c.ellipse(ax, groundY - 3, 18, 5, 0, 0, Math.PI * 2);
            c.fill();

            // Cuerpo
            c.fillStyle = '#5030a0';
            c.fillRect(ax - 12, ay + 15, 24, 35);

            // Cabeza
            c.fillStyle = '#7050c0';
            c.beginPath();
            c.arc(ax, ay, 15, 0, Math.PI * 2);
            c.fill();

            // Ojos brillantes
            c.fillStyle = '#a0ffff';
            c.beginPath();
            c.arc(ax - 5, ay - 2, 4, 0, Math.PI * 2);
            c.arc(ax + 5, ay - 2, 4, 0, Math.PI * 2);
            c.fill();

            c.fillStyle = '#40e0e0';
            c.beginPath();
            c.arc(ax - 4, ay - 2, 2, 0, Math.PI * 2);
            c.arc(ax + 6, ay - 2, 2, 0, Math.PI * 2);
            c.fill();

            // Etiqueta
            c.fillStyle = '#a080ff';
            c.font = 'bold 11px sans-serif';
            c.textAlign = 'center';
            c.fillText('PCP EXPLORER', ax, ay - 22);

            // Barra de presupuesto informacional
            const budget = state.agent.informationBudget || 0;
            const budgetWidth = 60;
            c.fillStyle = 'rgba(0,0,0,0.5)';
            c.fillRect(ax - budgetWidth/2, ay - 35, budgetWidth, 6);
            c.fillStyle = `rgb(${255 - budget/4}, ${budget/4}, 150)`;
            c.fillRect(ax - budgetWidth/2, ay - 35, budgetWidth * (budget/1000), 6);
            c.fillStyle = '#c0a0ff';
            c.font = '8px sans-serif';
            c.fillText(`Info: ${Math.round(budget)}`, ax, ay - 40);

            // Objeto sostenido
            if(state.agent.holding) {
                c.fillStyle = '#ff80a0';
                c.beginPath();
                c.arc(ax + 22, ay + 10, 10, 0, Math.PI * 2);
                c.fill();
                c.fillStyle = '#ffa0c0';
                c.font = '8px sans-serif';
                c.fillText(state.agent.holding, ax + 22, ay + 28);
            }
        }

        // Indicador de entrop√≠a
        const entropyVal = state.entropy || 0;
        c.fillStyle = '#60e0a0';
        c.font = 'bold 12px sans-serif';
        c.textAlign = 'right';
        c.fillText(`S = ${entropyVal.toFixed(3)}`, w - 15, 25);
        c.fillStyle = '#a080c0';
        c.font = '10px sans-serif';
        c.fillText(`t = ${(state.time || 0).toFixed(2)}s`, w - 15, 40);

        // Leyenda PCP
        c.fillStyle = 'rgba(20, 10, 40, 0.8)';
        c.fillRect(10, h - 60, 200, 50);
        c.fillStyle = '#a080c0';
        c.font = '9px sans-serif';
        c.textAlign = 'left';
        c.fillText('üåå PCP Universe', 15, h - 45);
        c.fillStyle = '#6090a0';
        c.fillText('‚Äï L√≠neas: correlaciones', 15, h - 32);
        c.fillText('‚óã Auras: coherencia cu√°ntica', 15, h - 20);
    },

    updateUI() {
        // HUD
        document.getElementById('timeValue').textContent = (state.time || 0).toFixed(1) + 's';
        document.getElementById('entropyValue').textContent = (state.entropy || 0).toFixed(3);
        document.getElementById('insightsCount').textContent = (laws.pcpInsights || []).length;
        document.getElementById('corrCount').textContent = (state.correlations || []).length;
        document.getElementById('lawsCount').textContent = (laws.discovered || []).length;

        // Tab Pensamiento
        const mindTab = document.getElementById('mind-tab');
        mindTab.innerHTML = thoughts.slice().reverse().map(t => `
            <div class="thought-card">
                <div class="thought-time">t = ${(t.time || 0).toFixed(1)}s</div>
                <div class="thought-text">${t.thinking || '...'}</div>
                ${t.action ? `<div class="thought-action">‚ö° ${t.action.type || 'WAIT'}</div>` : ''}
            </div>
        `).join('') || '<p style="color:#667;text-align:center;padding:20px;">Esperando pensamientos...</p>';

        // Tab Descubrimientos
        const lawsTab = document.getElementById('laws-tab');
        const insightsHtml = (laws.pcpInsights || []).map(i => `
            <div class="insight-card">
                <div class="insight-obs">üîÆ ${i.observation}</div>
                ${i.implication ? `<div class="insight-impl">‚Üí ${i.implication}</div>` : ''}
            </div>
        `).join('');

        const discoveredHtml = (laws.discovered || []).map(l => `
            <div class="law-card">
                <div class="law-name">‚úì ${l.name}</div>
                <div class="law-formula">${l.formula}</div>
                ${l.novelty ? `<div class="law-novelty">${l.novelty}</div>` : ''}
                <span class="law-confidence">${l.confidence}% confianza</span>
            </div>
        `).join('');

        const hypothesesHtml = (laws.hypotheses || []).map(h => `
            <div class="hypothesis-card">
                <div class="hypothesis-text">? ${h.description}</div>
                ${h.test ? `<div class="hypothesis-test">Test: ${h.test}</div>` : ''}
            </div>
        `).join('');

        lawsTab.innerHTML = `
            <h3 style="color:#40c0a0;margin-bottom:15px;">üîÆ PCP Insights (${(laws.pcpInsights || []).length})</h3>
            ${insightsHtml || '<p style="color:#556;padding:10px;">Explorando el universo informacional...</p>'}
            <h3 style="color:#60e0a0;margin:20px 0 15px;">‚úì Leyes Descubiertas (${(laws.discovered || []).length})</h3>
            ${discoveredHtml || '<p style="color:#556;padding:10px;">Ninguna ley descubierta a√∫n...</p>'}
            <h3 style="color:#c0a040;margin:20px 0 15px;">? Hip√≥tesis (${(laws.hypotheses || []).length})</h3>
            ${hypothesesHtml || '<p style="color:#556;padding:10px;">Ninguna hip√≥tesis formada...</p>'}
        `;

        // Tab Correlaciones
        const corrTab = document.getElementById('correlations-tab');
        corrTab.innerHTML = `
            <h3 style="color:#a060ff;margin-bottom:15px;">Correlaciones Activas (${(state.correlations || []).length})</h3>
            ${(state.correlations || []).map(c => `
                <div class="corr-card">
                    <div>
                        <div class="corr-objects">${c.objects.join(' ‚Üî ')}</div>
                        <div class="corr-type">${c.type} ${c.description ? `- ${c.description.substring(0,40)}...` : ''}</div>
                    </div>
                    <span class="corr-strength">${(c.strength * 100).toFixed(0)}%</span>
                </div>
            `).join('') || '<p style="color:#556;padding:10px;">No hay correlaciones visibles...</p>'}

            <div style="margin-top:20px;padding:15px;background:rgba(60,40,100,0.3);border-radius:8px;">
                <h4 style="color:#c080ff;margin-bottom:10px;">Sobre Correlaciones PCP</h4>
                <p style="color:#a080c0;font-size:11px;line-height:1.5;">
                    Las correlaciones contienen informaci√≥n "scrambled". Cuando objetos interact√∫an,
                    la informaci√≥n sobre sus estados pasados se distribuye en estas correlaciones.
                    Recuperarla requiere energ√≠a (l√≠mite de Landauer).
                </p>
            </div>
        `;

        // Tab Info Objetos
        const objTab = document.getElementById('objects-tab');
        objTab.innerHTML = `
            <h3 style="color:#c0a0ff;margin-bottom:15px;">Estado Informacional de Objetos</h3>
            ${(state.objects || []).map(o => `
                <div class="info-obj">
                    <div class="info-obj-header">
                        <span class="info-obj-name" style="color:${o.color}">${o.id}</span>
                        <span class="info-obj-coherence" style="color:${o.coherence > 0.5 ? '#60e0a0' : '#e06060'}">
                            œà = ${(o.coherence || 1).toFixed(3)}
                        </span>
                    </div>
                    <div style="font-size:10px;color:#8070a0;margin-bottom:8px;">
                        Masa: ${o.mass}kg | Material: ${o.material} | Scrambling: ${(o.scrambledPhase || 0).toFixed(3)}
                    </div>
                    <div style="font-size:9px;color:#6060a0;">Coherencia</div>
                    <div class="info-bar">
                        <div class="info-bar-fill" style="width:${(o.coherence || 1) * 100}%;background:linear-gradient(90deg,#40a080,#60e0a0);"></div>
                    </div>
                    <div style="font-size:9px;color:#6060a0;">Scrambling</div>
                    <div class="info-bar">
                        <div class="info-bar-fill" style="width:${Math.min(100, (o.scrambledPhase || 0) * 100)}%;background:linear-gradient(90deg,#a04080,#ff60a0);"></div>
                    </div>
                </div>
            `).join('')}

            <div style="margin-top:15px;padding:12px;background:rgba(40,80,60,0.3);border-radius:8px;">
                <h4 style="color:#60c080;margin-bottom:8px;">Presupuesto Informacional</h4>
                <div style="font-size:24px;color:#80e0a0;text-align:center;">${Math.round(state.agent?.informationBudget || 0)} / 1000</div>
                <div class="info-bar" style="margin-top:8px;">
                    <div class="info-bar-fill" style="width:${(state.agent?.informationBudget || 0) / 10}%;background:#40c080;"></div>
                </div>
                <p style="font-size:10px;color:#6090a0;margin-top:8px;">Energ√≠a disponible para QUERY_PAST</p>
            </div>
        `;

        // Tab Experimentos
        const expTab = document.getElementById('experiments-tab');
        expTab.innerHTML = experiments.slice().reverse().slice(0, 25).map(e => `
            <div class="exp-card">
                <span class="exp-time">[t=${(e.time || 0).toFixed(1)}s]</span>
                <span class="exp-action">${e.action?.type || 'UNKNOWN'}</span>
                <div class="exp-result">${(e.observation || '').substring(0, 150)}</div>
            </div>
        `).join('') || '<p style="color:#667;text-align:center;padding:20px;">Sin experimentos...</p>';
    },

    async reset() {
        await fetch('/reset', { method: 'POST' });
        await this.fetchData();
    },

    async generateReport() {
        try {
            const res = await fetch('/report');
            const report = await res.json();

            const html = `
                <div class="report-header">
                    <h1>üåå INFORME PCP - Present Containment Principle</h1>
                    <button onclick="document.getElementById('reportModal').style.display='none'"
                            style="background:#a04060;color:#fff;border:none;padding:10px 20px;cursor:pointer;border-radius:5px;">
                        Cerrar
                    </button>
                </div>

                <div class="report-section">
                    <h3>üìà RESUMEN DEL UNIVERSO</h3>
                    <p><strong>Tiempo simulado:</strong> ${report.summary.simulationTime.toFixed(1)}s</p>
                    <p><strong>Entrop√≠a actual:</strong> ${report.summary.totalEntropy.toFixed(4)}</p>
                    <p><strong>Estados en historial:</strong> ${report.summary.historyDepth}</p>
                    <p><strong>Correlaciones activas:</strong> ${report.summary.activeCorrelations}</p>
                    <p><strong>PCP Insights:</strong> ${report.summary.pcpInsights}</p>
                    <p><strong>Leyes descubiertas:</strong> ${report.summary.lawsDiscovered}</p>
                </div>

                <div class="report-section">
                    <h3>üîÆ INSIGHTS PCP</h3>
                    ${(report.pcpInsights || []).length === 0 ? '<p>Ning√∫n insight sobre informaci√≥n/reversibilidad a√∫n.</p>' :
                      report.pcpInsights.map(i => `
                        <div style="background:rgba(40,120,100,0.3);padding:12px;margin:10px 0;border-radius:6px;border-left:3px solid #40c0a0;">
                            <p style="color:#a0ffd0;">${i.observation}</p>
                            ${i.implication ? `<p style="color:#60a080;font-size:11px;margin-top:6px;">‚Üí ${i.implication}</p>` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>‚úì LEYES DESCUBIERTAS</h3>
                    ${report.discoveredLaws.length === 0 ? '<p>Ninguna ley descubierta a√∫n.</p>' :
                      report.discoveredLaws.map(l => `
                        <div style="background:rgba(40,100,80,0.3);padding:12px;margin:10px 0;border-radius:6px;">
                            <strong style="color:#60e0a0;">${l.name}</strong>
                            <div style="font-family:monospace;color:#a0ffc0;margin:8px 0;font-size:16px;">${l.formula}</div>
                            ${l.novelty ? `<p style="color:#80e0c0;font-size:11px;font-style:italic;">${l.novelty}</p>` : ''}
                            <span style="background:rgba(60,180,100,0.3);padding:3px 8px;border-radius:10px;font-size:10px;color:#80e0a0;">
                                ${l.confidence}% confianza
                            </span>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>‚Üî CORRELACIONES</h3>
                    ${(report.correlations || []).map(c => `
                        <div style="background:rgba(100,40,120,0.3);padding:10px;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;">
                            <div>
                                <span style="color:#d0a0ff;">${c.objects.join(' ‚Üî ')}</span>
                                <span style="color:#8060a0;font-size:10px;margin-left:10px;">[${c.type}]</span>
                            </div>
                            <span style="color:#e0c0ff;">${(c.strength * 100).toFixed(0)}%</span>
                        </div>
                    `).join('') || '<p>No hay correlaciones activas.</p>'}
                </div>

                <div class="report-section">
                    <h3>üìä EVOLUCI√ìN DE ENTROP√çA</h3>
                    <div style="display:flex;flex-wrap:wrap;gap:5px;">
                        ${(report.entropyHistory || []).slice(-30).map(e => `
                            <span style="background:rgba(60,180,120,0.3);padding:2px 6px;border-radius:3px;font-size:9px;color:#80e0a0;">
                                ${e.entropy.toFixed(3)}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div class="report-section">
                    <h3>üß† PROCESO DE PENSAMIENTO</h3>
                    ${report.thoughtProcess.map(t => `
                        <div style="padding:8px;margin:5px 0;border-left:2px solid #8040c0;padding-left:12px;">
                            <span style="color:#8060a0;font-size:10px;">[t=${t.time.toFixed(1)}s]</span>
                            <span style="color:#c080ff;font-size:11px;">${t.action?.type || 'THINK'}</span>
                            <p style="color:#c0b0d0;font-size:11px;margin-top:4px;">${(t.thinking || '').substring(0, 200)}...</p>
                        </div>
                    `).join('')}
                </div>

                <div class="report-section" style="border-left-color:#c0a040;">
                    <h3>üìú SOBRE EL PCP</h3>
                    <p style="font-style:italic;color:#d0c0a0;">
                        "El estado f√≠sico presente contiene TODA la informaci√≥n necesaria para reconstruir
                        cualquier estado pasado o predecir cualquier estado futuro. La irreversibilidad
                        no es ontol√≥gica sino epistemol√≥gica y energ√©tica."
                    </p>
                    <p style="margin-top:10px;color:#a09080;font-size:11px;">
                        Este universo simula la f√≠sica de informaci√≥n donde:
                        <br>‚Ä¢ La informaci√≥n nunca se destruye, solo se "scramble" en correlaciones
                        <br>‚Ä¢ Recuperar informaci√≥n pasada cuesta energ√≠a (l√≠mite de Landauer)
                        <br>‚Ä¢ La coherencia cu√°ntica decae con las interacciones
                        <br>‚Ä¢ La flecha del tiempo es un gradiente de accesibilidad
                    </p>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportModal').style.display = 'block';
        } catch(e) {
            console.error('Error generating report:', e);
            alert('Error generando informe');
        }
    }
};

window.onload = () => sim.init();
</script>
</body>
</html>
